<div class="articles-container">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">Bài viết kiến thức</h1>
      <p class="page-subtitle">Tạo nội dung học tập cho từng kỹ năng</p>
    </div>
    <button class="btn-primary" (click)="openModal()">
      <i class="fas fa-plus"></i>
      Tạo bài viết mới
    </button>
  </div>

  <!-- Filters Section -->
  <div class="filters-section">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" placeholder="Tìm kiếm bài viết..." [(ngModel)]="searchTerm" (input)="onSearchChange()">
    </div>

    <div class="filter-group">
      <select [(ngModel)]="selectedCategory" (change)="onCategoryChange()">
        <option value="">Tất cả danh mục</option>
        <option *ngFor="let category of categoryNames" [value]="category">
          {{ category }}
        </option>
      </select>

      <select [(ngModel)]="selectedStatus" (change)="onStatusChange()">
        <option value="">Tất cả trạng thái</option>
        <option value="published">Đã xuất bản</option>
        <option value="draft">Bản nháp</option>
        <option value="pending">Chờ duyệt</option>
      </select>

      <!-- Sorting -->
      <select [(ngModel)]="sortBy" (change)="changeSort(sortBy, sortDir)">
        <option value="createdAt">Mới nhất</option>
        <option value="title">Tiêu đề (A-Z)</option>
        <option value="category">Danh mục</option>
      </select>
      <select [(ngModel)]="sortDir" (change)="changeSort(sortBy, sortDir)">
        <option value="desc">Giảm dần</option>
        <option value="asc">Tăng dần</option>
      </select>

      <!-- Page size -->
      <select [ngModel]="pageSize" (ngModelChange)="changePageSize($event)">
        <option [ngValue]="10">10 / trang</option>
        <option [ngValue]="20">20 / trang</option>
        <option [ngValue]="50">50 / trang</option>
      </select>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="isLoading">
    <i class="fas fa-spinner fa-spin"></i>
    <p>Đang tải bài viết...</p>
  </div>

  <!-- Articles Grid -->
  <div class="articles-grid" *ngIf="!isLoading">
    <div class="article-card" *ngFor="let article of filteredArticles">
      <div class="article-status">
        <span [class]="getStatusClass(article.status)">
          {{ getStatusText(article.status) }}
        </span>
      </div>

      <div class="article-content">
        <h3 class="article-title">{{ article.title }}</h3>
        <p class="article-excerpt">{{ article.summary }}</p>

        <div class="article-meta">
          <div class="meta-item">
            <i class="fas fa-tag"></i>
            <span>{{ article.category }}</span>
          </div>
          <div class="meta-item">
            <i class="fas fa-calendar"></i>
            <span>{{ article.publishDate }}</span>
          </div>
          <div class="meta-item">
            <i class="fas fa-eye"></i>
            <span>{{ article.views | number }} lượt xem</span>
          </div>
          <div class="meta-item">
            <i class="fas fa-heart"></i>
            <span>{{ article.likes | number }} lượt thích</span>
          </div>
        </div>

        <div class="author-info">
          <div class="author-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="author-details">
            <span class="author-name">{{ article.author }}</span>
            <span class="author-role">{{ article.authorRole }}</span>
          </div>
        </div>
      </div>

      <div class="article-actions">
        <!-- Nút sửa luôn hiển thị -->
        <button class="btn-action btn-edit" (click)="openModal(article)">
          <i class="fas fa-edit"></i>
        </button>

        <!-- Nút Gửi duyệt cho Staff -->
        <button class="btn-action btn-submit" *ngIf="article.status === 'draft' && !isManager"
          (click)="submitForApproval(article.id)">
          <i class="fas fa-upload"></i>
        </button>

        <!-- Nút Phê duyệt và Từ chối cho Manager -->
        <ng-container *ngIf="article.status === 'pending' && isManager">
          <button class="btn-action btn-approve" (click)="approveArticle(article.id)">
            <i class="fas fa-check"></i> Duyệt
          </button>
          <button class="btn-action btn-reject" (click)="rejectArticle(article.id)">
            <i class="fas fa-times"></i> Từ chối
          </button>
        </ng-container>

        <!-- Nút xóa -->
        <button class="btn-action btn-delete" (click)="deleteArticle(article.id)">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <div class="flex items-center justify-center gap-4 mt-6" *ngIf="!isLoading && total > 0">
    <!-- Nút Trang trước -->
    <button (click)="prevPage()" [disabled]="page === 1" class="px-4 py-2 flex items-center gap-2 rounded-lg border border-gray-300 text-gray-700 
           bg-white hover:bg-gray-100 shadow-sm transition 
           disabled:opacity-40 disabled:cursor-not-allowed">
      <i class="fas fa-chevron-left"></i>
      <span>Trang trước</span>
    </button>

    <!-- Thông tin số trang -->
    <div class="px-5 py-2 bg-white shadow rounded-lg text-gray-700 font-medium">
      Trang
      <span class="font-semibold">{{ page }}</span> /
      <span class="font-semibold">{{ Math.ceil(total / pageSize) }}</span>
      · Tổng
      <span class="font-semibold">{{ total | number }}</span> bài
    </div>

    <!-- Nút Trang sau -->
    <button (click)="nextPage()" [disabled]="page * pageSize >= total" class="px-4 py-2 flex items-center gap-2 rounded-lg border border-gray-300 text-gray-700 
           bg-white hover:bg-gray-100 shadow-sm transition 
           disabled:opacity-40 disabled:cursor-not-allowed">
      <span>Trang sau</span>
      <i class="fas fa-chevron-right"></i>
    </button>
  </div>



  <!-- Empty State -->
  <div class="empty-state" *ngIf="!isLoading && filteredArticles.length === 0">
    <i class="fas fa-file-alt"></i>
    <h3>Không tìm thấy bài viết nào</h3>
    <p>Hãy thử thay đổi bộ lọc hoặc tạo bài viết mới</p>
  </div>
</div>

<!-- Modal - Giống y hệt form trong ảnh -->
<div class="modal-overlay" *ngIf="isModalOpen" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-header-content">
        <div class="modal-icon">
          <i class="fas fa-edit"></i>
        </div>
        <div class="modal-title-section">
          <h2>{{ editingArticle ? 'Chỉnh sửa bài viết' : 'Tạo bài viết mới' }}</h2>
          <p>Nhấp nội dung và định dạng theo từng section</p>
        </div>
      </div>
      <button class="btn-close" (click)="closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <form [formGroup]="articleForm" (ngSubmit)="saveArticle()" class="modal-form">
      <!-- Row 1: Danh mục và Trạng thái -->
      <div class="form-row">
        <div class="form-group">
          <label for="category">Danh mục</label>
          <select id="category" formControlName="category">
            <option value="">Chọn danh mục</option>
            <option *ngFor="let category of categoryNames" [value]="category">
              {{ category }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="status">Trạng thái</label>
          <select id="status" formControlName="status">
            <option value="draft">📝 Bản nháp</option>
            <option value="pending">⏳ Chờ duyệt</option>
            <option value="published">✅ Đã xuất bản</option>
          </select>
        </div>
      </div>

      <!-- Tiêu đề -->
      <div class="form-group">
        <label for="title">Tiêu đề</label>
        <input type="text" id="title" formControlName="title" placeholder="VD: 10 mẹo đạt 900+ TOEIC">
        <div class="error-message"
          *ngIf="articleForm.get('title')?.errors?.['required'] && articleForm.get('title')?.touched">
          Tiêu đề là bắt buộc
        </div>
        <div class="error-message"
          *ngIf="articleForm.get('title')?.errors?.['minlength'] && articleForm.get('title')?.touched">
          Tiêu đề phải có ít nhất 5 ký tự
        </div>
      </div>

      <!-- Tóm tắt -->
      <div class="form-group">
        <label for="summary">Tóm tắt</label>
        <textarea id="summary" formControlName="summary" rows="3" placeholder="Nhập đoạn mô tả/tóm tắt..."></textarea>
        <div class="error-message"
          *ngIf="articleForm.get('summary')?.errors?.['required'] && articleForm.get('summary')?.touched">
          Tóm tắt là bắt buộc
        </div>
        <div class="error-message"
          *ngIf="articleForm.get('summary')?.errors?.['minlength'] && articleForm.get('summary')?.touched">
          Tóm tắt phải có ít nhất 20 ký tự
        </div>
      </div>

      <!-- Các phần nội dung -->
      <div class="form-group">
        <label>Các phần nội dung</label>

        <div formArrayName="sections">
          <div *ngFor="let section of sections.controls; let i = index" [formGroupName]="i" class="section-item">

            <div class="section-header">
              <div class="section-title-group">
                <label>Tiêu đề phần</label>
                <input type="text" formControlName="sectionTitle" placeholder="Nhập tiêu đề phần...">
              </div>

              <div class="section-type-group">
                <label>Loại phần</label>
                <select formControlName="type">
                  <option *ngFor="let type of sectionTypes" [value]="type.value">
                    {{ type.label }}
                  </option>
                </select>
              </div>

              <div class="section-content-group">
                <label>Nội dung</label>
                <textarea formControlName="content" rows="3" placeholder="Nhập nội dung..."></textarea>
              </div>
            </div>

            <div class="section-controls">
              <button type="button" class="btn-control btn-up" (click)="moveSectionUp(i)" [disabled]="i === 0">
                <i class="fas fa-arrow-up"></i>
              </button>
              <button type="button" class="btn-control btn-down" (click)="moveSectionDown(i)"
                [disabled]="i === sections.length - 1">
                <i class="fas fa-arrow-down"></i>
              </button>
              <button type="button" class="btn-control btn-remove" (click)="removeSection(i)">
                <i class="fas fa-trash text-red"></i> Xóa
              </button>
            </div>
          </div>
        </div>

        <button type="button" class="btn-add-section" (click)="addSection()">
          <i class="fas fa-plus"></i> Thêm phần
        </button>
      </div>

      <!-- Tags -->
      <div class="form-group">
        <label for="tags">Tags</label>
        <input type="text" id="tags" formControlName="tags" placeholder="VD: TOEIC, Listening, 900 điểm">
        <small class="form-hint">Phân cách các tag bằng dấu phẩy</small>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closeModal()">
          Lưu nháp
        </button>
        <button type="submit" class="btn-primary" [disabled]="!articleForm.valid || isSubmitting">
          <span *ngIf="isSubmitting" class="loading-spinner"></span>
          {{ isSubmitting ? 'Đang xử lý...' : (editingArticle ? 'Cập nhật' : 'Lưu & Xuất bản') }}
        </button>
      </div>
    </form>
  </div>
</div>