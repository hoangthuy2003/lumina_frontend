
@if (questions && questions.length > 0 && !isFinished) {
<div class="bg-white rounded-lg border border-gray-200 shadow-sm p-5 flex flex-col gap-3">
  <!-- Header with Timer and Question Info -->
  <div class="flex items-start justify-between gap-3">
    <div class="space-y-2">
      <app-time
        [time]="questions[currentIndex].time"
        [resetAt]="currentIndex"
        [paused]="showExplain"
        (timeout)="onTimeout()"
      ></app-time>
    </div>
  </div>

  <!-- Question Content -->
  @if (getCurrentQuestion()) {
    <div class="border border-gray-200 rounded-lg p-4 mb-4">
      <div class="mb-3">
        <h4 class="font-medium text-gray-900 mb-2">
          Câu {{ currentIndex + 1 }}: {{ getCurrentQuestion()?.stemText }}
        </h4>
        @if (getCurrentQuestion()?.prompt?.contentText) {
          <div class="font-medium text-gray-600 mb-2">
            <strong>{{ getCurrentQuestion()?.prompt?.title }}</strong>
            {{ getCurrentQuestion()?.prompt?.contentText }}
          </div>
        }
      </div>

      @if (getCurrentQuestion()?.prompt?.referenceImageUrl) {
        <div class="mb-4 mx-auto">
          <img
            [src]="getCurrentQuestion()?.prompt?.referenceImageUrl"
            [alt]="'Question ' + (currentIndex + 1) + ' image'"
            class="max-w-full w-8/12 mx-auto h-auto rounded-lg border border-gray-200"
          >
        </div>


      <div class="mb-4">
        <button
          class="btn border-s-blue-400 inline-flex items-center gap-2 px-4 py-2 rounded-md border border-blue-500 text-blue-600 hover:bg-blue-50 active:bg-blue-100 disabled:opacity-60 disabled:cursor-not-allowed shadow-sm"
          (click)="showHint()"
          [disabled]="isLoading"
        >
          Show Hint
        </button>
        @if (isLoading) {
          <svg
            class="animate-spin h-4 w-4 text-blue-600 inline-block ml-2"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
            <path d="M4 12h16" stroke="currentColor" stroke-width="4" stroke-linecap="round" />
          </svg>
        }@if (isShowHint && !isLoading) {
          <span class="ml-2 text-sm text-gray-600"
            *ngIf="pictureCaption">Caption: {{ pictureCaption }}</span>
        }
      </div>
    }

      <!-- Writing Answer Box -->
      <app-writing-answer-box
        [questionId]="getCurrentQuestion()?.questionId || 0"
        [disabled]="showExplain"
        [resetAt]="currentIndex"
        [contentText]="getCurrentQuestion()?.prompt?.contentText"
        [pictureCaption]="pictureCaption"
        (answered)="onAnswerSubmitted(getCurrentQuestion()?.questionId || 0, $event)"
        (answerChange)="onAnswerChange($event.questionId, $event.answer)"
      ></app-writing-answer-box>
    </div>
  }

  @if (showExplain) {
    <div class="mt-3 p-3 rounded-md bg-blue-50 border border-blue-200 text-blue-800 text-sm">
      {{ getCurrentQuestion()?.questionExplain }}
    </div>
  }
</div>
} @if (isFinished) {
<div class="mt-4 bg-white rounded-lg border border-gray-200 shadow-sm p-5">
  <div class="flex items-center justify-between">
    <div class="text-gray-800 font-semibold">Hoàn thành</div>
    <div class="text-sm text-gray-600">Điểm: {{ totalScore }}</div>
  </div>
  <div class="mt-3 text-gray-700">
    Bạn trả lời đúng {{ correctCount }}/{{ questions?.length || 0 }} ({{
      percentCorrect
    }}%).
  </div>
  <div
    class="mt-2 p-3 rounded-md"
    [ngClass]="{
      'bg-red-50 text-red-700 border border-red-200': percentCorrect < 30,
      'bg-yellow-50 text-yellow-700 border border-yellow-200':
        percentCorrect >= 30 && percentCorrect < 60,
      'bg-green-50 text-green-700 border border-green-200': percentCorrect >= 60
    }"
  >
    {{ feedbackText }}
  </div>
  <div class="mt-4">
    <div class="text-sm font-medium text-gray-700 mb-2">
      Câu trả lời đã lưu (localStorage)
    </div>
    @if (savedAnswers && savedAnswers.length > 0) {
      <ul class="pl-0 text-sm text-gray-700 space-y-1">
        @for (ans of savedAnswers; track ans.questionId) {
          <li class="flex items-center gap-2">
            <span class="inline-block min-w-24">Câu {{ ans.questionId }}</span>
            <span class="inline-block">→ Đã lưu: {{ ans.answer.length }} ký tự</span>
          </li>
        }
      </ul>
    } @else {
      <div class="text-sm text-gray-500">Không có dữ liệu lưu.</div>
    }
    <button
      class="mt-3 px-3 py-1.5 rounded bg-red-600 text-white hover:bg-red-700"
      (click)="clearSavedData()"
    >
      Xóa lưu trữ
    </button>
  </div>
  <div class="flex gap-4">
    <div class="mt-4">
      <button
        class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
        (click)="resetExam()"
      >
        Làm lại
      </button>
    </div>
  </div>
</div>
}

