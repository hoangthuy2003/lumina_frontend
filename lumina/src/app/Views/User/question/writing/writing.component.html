
@if (questions && questions.length > 0 && !isFinished) {
<div class="bg-white rounded-lg border border-gray-200 shadow-sm p-5 flex flex-col gap-3">
  <!-- Header with Timer and Question Info -->
  <div class="flex items-start justify-between gap-3">
    <div class="space-y-2">
      <app-time
        [time]="questions[currentIndex].time"
        [resetAt]="currentIndex"
        [paused]="showExplain"
        (timeout)="onTimeout()"
      ></app-time>
    </div>

  </div>

  <!-- Question Content -->
  @if (getCurrentQuestion()) {
    <div class="border border-gray-200 rounded-lg p-4 mb-4">
      <div class="mb-3">
        <h4 class="font-medium text-gray-900 mb-2">
          C√¢u {{ currentIndex + 1 }}: {{ getCurrentQuestion()?.stemText }}
        </h4>
        @if (getCurrentQuestion()?.prompt?.contentText) {
          <div class="font-medium text-gray-600 mb-2">
            <strong>{{ getCurrentQuestion()?.prompt?.title }}</strong>
            {{ getCurrentQuestion()?.prompt?.contentText }}
          </div>
        }
      </div>

      @if (getCurrentQuestion()?.prompt?.referenceImageUrl) {
        <div class="mb-4 mx-auto">
          <img
            [src]="getCurrentQuestion()?.prompt?.referenceImageUrl"
            [alt]="'Question ' + (currentIndex + 1) + ' image'"
            class="max-w-full w-8/12 mx-auto h-auto rounded-lg border border-gray-200"
          >
        </div>
      }

      <div class="mb-4">
        <button
          class="btn border-s-blue-400 inline-flex items-center gap-2 px-4 py-2 rounded-md border border-blue-500 text-blue-600 hover:bg-blue-50 active:bg-blue-100 disabled:opacity-60 disabled:cursor-not-allowed shadow-sm"
          (click)="showHint()"
          [disabled]="isLoading"
        >
          Show Hint
        </button>
        @if (isLoading) {
          <svg
            class="animate-spin h-4 w-4 text-blue-600 inline-block ml-2"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
            <path d="M4 12h16" stroke="currentColor" stroke-width="4" stroke-linecap="round" />
          </svg>
        }@if (isShowHint && !isLoading) {
          <span class="ml-2 text-sm text-gray-600"
            *ngIf="pictureCaption">Caption: {{ pictureCaption }}</span>
        }
      </div>

      <!-- Writing Answer Box -->
      <app-writing-answer-box
        [questionId]="getCurrentQuestion()?.questionId || 0"
        [disabled]="showExplain"
        [resetAt]="currentIndex"
        [contentText]="getCurrentQuestion()?.prompt?.contentText"
        [pictureCaption]="pictureCaption"
        (answered)="onAnswerSubmitted(getCurrentQuestion()?.questionId || 0, $event)"
        (answerChange)="onAnswerChange($event.questionId, $event.answer)"
      ></app-writing-answer-box>
    </div>
  }

  <!-- Navigation Controls -->
  <div class="mt-4">
    <!-- Question Status List -->
    <div class="mb-4 p-3 bg-gray-50 rounded-lg">
      <h4 class="text-sm font-semibold text-gray-700 mb-2">
        Danh s√°ch c√¢u h·ªèi:
      </h4>
      <div class="flex flex-wrap gap-2">
        @for (question of questions; track question.questionId; let i = $index) {
          <button
            (click)="navigateToQuestion(i)"
            [class]="
              'px-3 py-1 text-xs rounded-full border transition-colors ' +
              (isCurrentQuestion(i)
                ? 'bg-blue-100 border-blue-300 text-blue-700'
                : 'bg-white border-gray-300 text-gray-600 hover:bg-gray-100')
            "
          >
            üìù C√¢u {{ i + 1 }}
          </button>
        }
      </div>
    </div>

    <!-- Navigation Controls -->
    <div class="flex items-center justify-between">
      <div class="flex gap-2">
        <button
          (click)="previousQuestion()"
          [disabled]="currentIndex === 0"
          class="px-4 py-2 rounded bg-gray-600 text-white hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          ‚Üê Previous
        </button>
        <button
          (click)="nextQuestion()"
          [disabled]="currentIndex >= questions.length - 1"
          class="px-4 py-2 rounded bg-gray-600 text-white hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Next ‚Üí
        </button>
      </div>

      <div class="flex items-center gap-3">
        <div class="text-sm text-gray-500">
          C√¢u {{ currentIndex + 1 }} / {{ questions.length }}
        </div>
        <button
          (click)="finishExam()"
          class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700"
        >
          N·ªôp b√†i thi
        </button>
      </div>
    </div>
  </div>

  @if (showExplain) {
    <div class="mt-3 p-3 rounded-md bg-blue-50 border border-blue-200 text-blue-800 text-sm">
      {{ getCurrentQuestion()?.questionExplain }}
    </div>
  }
</div>
} @if (isFinished) {
<div class="mt-4 bg-white rounded-lg border border-gray-200 shadow-sm p-5">
  <div class="flex items-center justify-between">
    <div class="text-gray-800 font-semibold">Ho√†n th√†nh</div>
    <div class="text-sm text-gray-600">ƒêi·ªÉm: {{ totalScore }}</div>
  </div>
  <div class="mt-3 text-gray-700">
    B·∫°n tr·∫£ l·ªùi ƒë√∫ng {{ correctCount }}/{{ questions?.length || 0 }} ({{
      percentCorrect
    }}%).
  </div>
  <div
    class="mt-2 p-3 rounded-md"
    [ngClass]="{
      'bg-red-50 text-red-700 border border-red-200': percentCorrect < 30,
      'bg-yellow-50 text-yellow-700 border border-yellow-200':
        percentCorrect >= 30 && percentCorrect < 60,
      'bg-green-50 text-green-700 border border-green-200': percentCorrect >= 60
    }"
  >
    {{ feedbackText }}
  </div>
  <div class="mt-4">
    <div class="text-sm font-medium text-gray-700 mb-2">
      C√¢u tr·∫£ l·ªùi ƒë√£ l∆∞u (localStorage)
    </div>
    @if (savedAnswers && savedAnswers.length > 0) {
      <ul class="pl-0 text-sm text-gray-700 space-y-1">
        @for (ans of savedAnswers; track ans.questionId) {
          <li class="flex items-center gap-2">
            <span class="inline-block min-w-24">C√¢u {{ ans.questionId }}</span>
            <span class="inline-block">‚Üí ƒê√£ l∆∞u: {{ ans.answer.length }} k√Ω t·ª±</span>
          </li>
        }
      </ul>
    } @else {
      <div class="text-sm text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu l∆∞u.</div>
    }
    <button
      class="mt-3 px-3 py-1.5 rounded bg-red-600 text-white hover:bg-red-700"
      (click)="clearSavedData()"
    >
      X√≥a l∆∞u tr·ªØ
    </button>
  </div>
  <div class="flex gap-4">
    <div class="mt-4">
      <button
        class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
        (click)="resetExam()"
      >
        L√†m l·∫°i
      </button>
    </div>
  </div>
</div>
}

