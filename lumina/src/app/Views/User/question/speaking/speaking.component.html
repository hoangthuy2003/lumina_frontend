@if (questions && questions.length > 0 && !finished) {
<div
  class="bg-white rounded-lg border border-gray-200 shadow-sm p-5 flex flex-col gap-3"
>
  <div class="flex items-start justify-between gap-3">
    <div class="space-y-2">
      <app-time
        [time]="questions[currentIndex].time"
        [resetAt]="currentIndex"
        [paused]="showExplain"
        (timeout)="onTimeout()"
      ></app-time>
    </div>
    <h3 class="text-lg font-semibold text-gray-800 flex-1">
      {{ questions[currentIndex].stemText }}
    </h3>
    <span class="text-xs text-gray-500 inline-flex items-center gap-2">
      <span class="bg-gray-100 px-2 py-1 rounded"
        >Type: {{ questions[currentIndex].questionType }}</span
      >
      <span class="bg-gray-100 px-2 py-1 rounded"
        >Score: {{ questions[currentIndex].scoreWeight }}</span
      >
      <span class="bg-green-100 text-green-700 px-2 py-1 rounded font-medium"
        >ƒêi·ªÉm c·ªßa b·∫°n: {{ totalScore }}</span
      >
    </span>
  </div>

  <div class="grid gap-4 mt-3">
    <div class="space-y-2">
      <app-prompt
        [prompt]="questions[currentIndex].prompt"
        [resetAt]="currentIndex"
        [questionType]="questions[currentIndex].questionType"
        (pictureCaptionChange)="onPictureCaption($event)"
      ></app-prompt>
    </div>
  </div>

  <div class="mt-2">
    @if (isSpeakingQuestion(questions[currentIndex].questionType)) {
    <app-speaking-answer-box
      [questionId]="questions[currentIndex].questionId"
      [disabled]="showExplain"
      [resetAt]="resetCounter"
      [questionTime]="questions[currentIndex].time"
      (answered)="onSpeakingAnswered($event)"
      (scoringResult)="onSpeakingResult($event)"
      (submitting)="onSpeakingSubmitting($event)"
    ></app-speaking-answer-box>
    }

    <!-- Navigation for Speaking Questions -->
    <div class="mt-4">
      <!-- Question Status List -->
      <div class="mb-4 p-3 bg-gray-50 rounded-lg">
        <h4 class="text-sm font-semibold text-gray-700 mb-2">
          Danh s√°ch c√¢u h·ªèi:
        </h4>
        <div class="flex flex-wrap gap-2">
          @for (question of questions; track question.questionId; let i =
          $index) {
          <button
            (click)="navigateToQuestion(i)"
            [class]="
              'px-3 py-1 text-xs rounded-full border transition-colors ' +
              (isCurrentQuestion(i)
                ? 'bg-blue-100 border-blue-300 text-blue-700'
                : 'bg-white border-gray-300 text-gray-600 hover:bg-gray-100')
            "
          >
            {{ getQuestionStateIcon(question.questionId) }} C√¢u {{ i + 1 }}
          </button>
          }
        </div>
      </div>

      <!-- Navigation Controls -->
      <div class="flex items-center justify-between">
        <div class="flex gap-2">
          <button
            (click)="previousQuestion()"
            [disabled]="currentIndex === 0"
            class="px-4 py-2 rounded bg-gray-600 text-white hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            ‚Üê Previous
          </button>
          <button
            (click)="nextQuestionManual()"
            [disabled]="currentIndex >= questions.length - 1"
            class="px-4 py-2 rounded bg-gray-600 text-white hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Next ‚Üí
          </button>
        </div>

        <div class="flex items-center gap-3">
          <div class="text-sm text-gray-500">
            C√¢u {{ currentIndex + 1 }} / {{ questions.length }}
          </div>
          <button
            (click)="finishSpeakingExam()"
            class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700"
          >
            N·ªôp b√†i thi
          </button>
        </div>
      </div>
    </div>
  </div>

  @if (showExplain) {
  <div
    class="mt-3 p-3 rounded-md bg-blue-50 border border-blue-200 text-blue-800 text-sm"
  >
    {{ questions[currentIndex].questionExplain }}
  </div>
  }
</div>
} @if (finished) {
<div class="mt-4 bg-white rounded-lg border border-gray-200 shadow-sm p-5">
  <div class="flex items-center justify-between">
    <div class="text-gray-800 font-semibold">Ho√†n th√†nh</div>
    <div class="text-sm text-gray-600">ƒêi·ªÉm: {{ totalScore }}</div>
  </div>
  <div class="mt-3 text-gray-700">
    B·∫°n tr·∫£ l·ªùi ƒë√∫ng {{ correctCount }}/{{ questions.length }} ({{
      percentCorrect
    }}%).
  </div>
  <div
    class="mt-2 p-3 rounded-md"
    [ngClass]="{
      'bg-red-50 text-red-700 border border-red-200': percentCorrect < 30,
      'bg-yellow-50 text-yellow-700 border border-yellow-200':
        percentCorrect >= 30 && percentCorrect < 60,
      'bg-green-50 text-green-700 border border-green-200': percentCorrect >= 60
    }"
  >
    {{ feedbackText }}
  </div>
  <div class="flex gap-4">
    <div class="mt-4">
      <button
        class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
        (click)="resetQuiz()"
      >
        L√†m l·∫°i
      </button>
    </div>

    <div class="mt-4">
      <button
        class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
        (click)="goToExams()"
      >
        C√°c ƒë·ªÅ kh√°c
      </button>
    </div>
  </div>
</div>
}

<!-- Speaking Summary Modal (Full Screen Overlay) -->
@if (showSpeakingSummary) {
<div
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
>
  <div
    class="bg-white rounded-lg shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto"
  >
    <!-- Modal Header -->
    <div
      class="sticky top-0 bg-white border-b border-gray-200 p-4 flex justify-between items-center z-10"
    >
      <h2 class="text-2xl font-bold text-gray-800">
        üìä K·∫øt qu·∫£ TOEIC Speaking Test
      </h2>
      <button
        (click)="closeSpeakingSummary()"
        class="text-gray-500 hover:text-gray-700 text-2xl font-bold w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors"
        aria-label="ƒê√≥ng"
      >
        √ó
      </button>
    </div>

    <!-- Modal Body -->
    <div class="p-6">
      <app-speaking-summary
        [results]="speakingQuestionResults"
        (retryTest)="onRetrySpeakingTest()"
        (tryOtherTest)="onTryOtherSpeakingTest()"
      ></app-speaking-summary>

      <!-- Action buttons are now inside SpeakingSummaryComponent -->
    </div>
  </div>
</div>
}
